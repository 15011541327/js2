<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no" />
		<title>04_音悦tai</title>
		<!--onorientationchange-->
		<link href="css/index.css" rel="stylesheet"/>
	</head>
<body>
	<section class="wrap">
		<!--音悦台头部-->
		<header id="header">
			<!--logo和按钮区-->
			<div class="headerT">
				<!--logo-->
				<h1 id="logo">
					<a href="javascript:void(0)">
						<img src="img/logo.png" />
					</a>
				</h1>
				<!--菜单按钮-->
				<a href="javascript:void(0)" id="menuBtn" class="menuBtnClos"></a>
				<!--按钮排-->
				<div id="btns">
					<a href="javascript:void(0)" class="searchBtn">搜索</a>
					<a href="javascript:void(0)">登录</a>
					<a href="javascript:void(0)">注册</a>
				</div>
			</div>
			
			<!--搜索区-->
			<form id="search">
				<input type="text" placeholder="请输入搜索内容"/>
				<input type="submit" />
			</form>
			
			<!--头部的菜单-->
			<ul id="nav">
					<li>
			            <a href="javascript:void(0);" >首页</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >MV</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >悦单</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >V榜</a>
			        </li>
				    <li>
				    	<a href="javascript:void(0);" >音悦stage</a>
				    </li>
			        <li>
			            <a href="javascript:void(0);" >商城</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >节目</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >饭团</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >资讯</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >我的家</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >APP下载</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);" >热门应用</a>
			        </li>
				</ul>
		</header>
		<section id="content">
			<div id="navScroll">
				<ul id="navs">
					<li class="active">
			            <a href="javascript:void(0);">首页</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">MV</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">悦单</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">V榜</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">商城</a>
			        </li>
				    <li>
				    	<a href="javascript:void(0);">众筹</a>
				    </li>
			        <li>
			            <a href="javascript:void(0);">饭团</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">节目</a>
			       	</li>
			       <li>
			            <a href="javascript:void(0);">音悦stage</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">APP下载</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">资讯</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">我的家</a>
			        </li>
			        <li>
			            <a href="javascript:void(0);">热门应用</a>
			        </li>
				</ul>
			</div>
			<div id="picTab">
				<ul id="picList">
					<li>
						<a href="javascript:void(0)">
							<img src="img/1.jpg"/>
						</a>
					</li>
					<li>
						<a href="javascript:void(0)">
							<img src="img/2.jpg"/>
						</a>
					</li>
					<li>
						<a href="javascript:void(0)">
							<img src="img/3.jpg"/>
						</a>
					</li>
					<li>
						<a href="javascript:void(0)">
							<img src="img/4.jpg"/>
						</a>
					</li>
					<li>
						<a href="javascript:void(0)">
							<img src="img/5.jpg"/>
						</a>
					</li>
				</ul>
				<div id="picNav">
					<span class="active"></span>
					<span></span>
					<span></span>
					<span></span>
					<span></span>
				</div>
			</div>
			<section class="tab">
				<header class="tabHeader">
					<h2>MV首播</h2>
					<a href="###">更多&gt;</a>
				</header>
				<nav class="tabNav">
					<a href="###">全部</a>
					<a href="###">内地</a>
					<a href="###">港台</a>
					<a href="###">欧美</a>
					<a href="###">韩国</a>
					<a href="###">日本</a>
					<span></span>
				</nav>
				<section class="tabList">
					<ul class="tabNext"></ul>
					<ul class="tabShow">
						<li>
							<a href="#">
								<img src="img/a.jpg"/>
								<span>云画的月光 完整版 云画的月光 完整版 云画的月光 完整版</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/b.jpg"/>
								<span>WILD WILD WILD</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/c.jpg"/>
								<span>欲望付出 官方版</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/d.jpg"/>
								<span>NOIR～ノワール～ </span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/e.jpg"/>
								<span>Circles</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/f.jpg"/>
								<span>当我们混在一起 夏日泳池版</span>
							</a>
						</li>
					</ul>
					<ul class="tabNext"></ul>
				</section>
			</section>
			<section class="tab">
				<header class="tabHeader">
					<h2>MV首播</h2>
					<a href="###">更多&gt;</a>
				</header>
				<nav class="tabNav">
					<a href="###">全部</a>
					<a href="###">内地</a>
					<a href="###">港台</a>
					<a href="###">欧美</a>
					<a href="###">韩国</a>
					<a href="###">日本</a>
					<span></span>
				</nav>
				<section class="tabList">
					<ul class="tabNext"></ul>
					<ul class="tabShow">
						<li>
							<a href="#">
								<img src="img/a.jpg"/>
								<span>云画的月光 完整版 云画的月光 完整版 云画的月光 完整版</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/b.jpg"/>
								<span>WILD WILD WILD</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/c.jpg"/>
								<span>欲望付出 官方版</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/d.jpg"/>
								<span>NOIR～ノワール～ </span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/e.jpg"/>
								<span>Circles</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/f.jpg"/>
								<span>当我们混在一起 夏日泳池版</span>
							</a>
						</li>
					</ul>
					<ul class="tabNext"></ul>
				</section>
			</section>
			<section class="tab">
				<header class="tabHeader">
					<h2>MV首播</h2>
					<a href="###">更多&gt;</a>
				</header>
				<nav class="tabNav">
					<a href="###">全部</a>
					<a href="###">内地</a>
					<a href="###">港台</a>
					<a href="###">欧美</a>
					<a href="###">韩国</a>
					<a href="###">日本</a>
					<span></span>
				</nav>
				<section class="tabList">
					<ul class="tabNext"></ul>
					<ul class="tabShow">
						<li>
							<a href="#">
								<img src="img/a.jpg"/>
								<span>云画的月光 完整版 云画的月光 完整版 云画的月光 完整版</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/b.jpg"/>
								<span>WILD WILD WILD</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/c.jpg"/>
								<span>欲望付出 官方版</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/d.jpg"/>
								<span>NOIR～ノワール～ </span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/e.jpg"/>
								<span>Circles</span>
							</a>
						</li>
						<li>
							<a href="#">
								<img src="img/f.jpg"/>
								<span>当我们混在一起 夏日泳池版</span>
							</a>
						</li>
					</ul>
					<ul class="tabNext"></ul>
				</section>
			</section>
		</section>
	</section>
</body>
<script src="js/transform.js"></script>
<script>
		//rem适配方案
		setRem();
		window.addEventListener("onorientationchange" in window ? "orientationchange":"resize",function(){
			setRem();
		})
		function setRem(){
			var html = document.querySelector("html");
			width = html.getBoundingClientRect().width;
			html.style.fontSize = width/16 +"px";
		}
		
		//菜单切换
		CMFCMenuBar();
		function CMFCMenuBar(){
			var menuBtnEl = document.querySelector("#menuBtn");
			var navEl = document.querySelector("#nav");
			
			menuBtnEl.addEventListener("touchstart",function(ev){
				if(this.className=="menuBtnClos"){
					this.className="menuBtnShow"
					navEl.style.display="block";
				}else{
					this.className="menuBtnClos"
					navEl.style.display="none";
				}
				ev.stopPropagation();
			});
			
			document.addEventListener("touchstart",function(){
				if(menuBtnEl.className=="menuBtnShow"){
					menuBtnEl.className="menuBtnClos"
					navEl.style.display="none";
				}
			});
			
			navEl.addEventListener("touchstart",function(ev){
				ev.stopPropagation();
			});
			
		}

		//可拖拽的导航
		dragNav();
		function dragNav(){
			var navScroll = document.querySelector("#navScroll");
			var navs = document.querySelector("#navs");
			
			//开启3d硬件加速
			cssTransform(navs,"translateZ",0.00001);
			
			//定义手指初始位置(X)
			var startpoint=0;
			//定义ul的初始位置(X)
			var startX =0;
			
			var minX =navScroll.clientWidth - navs.offsetWidth;
			
			//定义手指滑动距离与ul移动距离的一个比例
			var flag = 1;
			
			//上一次的位置
			var lastDis = 0;
			//上一次的时间值
			var lastTime = 0;
			//距离的差值
			var disVal=0;
			//时间差值
			var disTime =0;
			
			navScroll.addEventListener("touchstart",function(ev){
				navs.style.transition ="none";
				
				startpoint = ev.changedTouches[0].clientX;
				startX = cssTransform(navs,"translateX");
				
				
				lastDis = startpoint;
				lastTime = new Date().getTime();
				disVal=0;
				disTime =1;//解决点击时候的一个bug
				
			});
			
			navScroll.addEventListener("touchmove",function(ev){
				var nowpoint = ev.changedTouches[0].clientX;
				var dis =nowpoint - startpoint;
				var translateX = startX+dis;
				var nowTime =new Date().getTime();
				if(translateX>0){
//					translateX =0;
					flag = 0.6-translateX/(navScroll.clientWidth*2);
					translateX =translateX*flag;
				}
				if(translateX<minX){
					var over =  minX - translateX;
					flag = 0.6-over/(navScroll.clientWidth*2);
					translateX =minX-over*flag;
//					translateX=minX;
				}
				
				disVal=nowpoint - lastDis;
				disTime =nowTime - lastTime;
				lastDis = nowpoint;
				lastTime = nowTime;
				
				
				cssTransform(navs,"translateX",translateX);
			});
			
			
			navScroll.addEventListener("touchend",function(){
				var speed = disVal /disTime;
				var translateX = cssTransform(navs,"translateX");
				var traget = translateX+ speed*300;
				var time = Math.abs(traget*1.2);
					time=time < 300?300:time;
				var bessel ="";
				if(traget>0){
					traget=0;
					bessel ="cubic-bezier(.12,.39,.61,1.75)";
				}
				if(traget<minX){
					traget=minX;
					bessel ="cubic-bezier(.12,.39,.61,1.75)";
				}
				
				navs.style.transition=time+"ms "+bessel;
				cssTransform(navs,"translateX",traget);
			});
		}

		//轮播
		carouselFigure();
		function carouselFigure(){
			var css = document.createElement("style");
			document.head.appendChild(css);
			var wrap = document.querySelector("#picTab");
			var list = document.querySelector("#picList");
			
			//开启3d硬件加速
			cssTransform(list,"translateZ",0.00001);
			
			list.innerHTML += list.innerHTML;
			
			var lis = document.querySelectorAll("#picList li");
			var nav = document.querySelectorAll("#picNav span");
			
			
			
			/*问题:
					1.ul拿的是父元素的100%--->一路往上找--->414px
					2.ul的宽度应该为414 * li的个数 才能在一行放下所有的li
					3.li应该设置为 (1/lis.length*100)%
					4.img的样式应该控制为 宽高自适应
					
					5.实现轮播效果,需要ul为绝对定位
					6.设置ul绝对定位后,wapper高度无法被撑开,需要js来控制
							wapper高度应与某一个li的高度一至
				*/
			setTimeout(function(){
				var style ="#picList{width:"+lis.length+"00%;}";
				style+="#picList li{width: "+(1/lis.length*100)+"%;}";
				style+="#picTab{height:"+lis[0].offsetHeight+"px;}";
				css.innerHTML+= style;
			},20);
			
			//开始滑屏
			var startpoint =0;
			var startX=0;
			//偏移量容器
			cssTransform(list,"translateX",0);
			var now=0;
			var clearTime =0;
			
			//判断是否为x轴滑动
			var isX =true;
			
			//判断是否为第一次
			var isFirst =true;
			
			wrap.addEventListener("touchstart",function(ev){
				clearInterval(clearTime);
				list.style.transition="none";
				
				
				if(now ==0){
					now=nav.length;
				}
				if(now==lis.length-1){
					now=nav.length-1
				}
				cssTransform(list,"translateX",-now*wrap.offsetWidth);
				
				
				var touch ={clientX:ev.changedTouches[0].clientX,clientY:ev.changedTouches[0].clientY};
				startpoint = touch;
				startX= cssTransform(list,"translateX");
				
				isX =true;
				isFirst = true;
			});
			
			wrap.addEventListener("touchmove",function(ev){
				if(!isX){
					return;
				}
				
				var touch =ev.changedTouches[0];
				var nowpoint=touch;
				var disX =nowpoint.clientX -startpoint.clientX;
				var disY =nowpoint.clientY -startpoint.clientY;
				
				var test =document.querySelector("input");
				test.value=disX;
				
				if(isFirst){
					isFirst = false;
					if(Math.abs(disY)>Math.abs(disX)){
						isX=false;
						return;
					}
				}
				
				
				
				cssTransform(list,"translateX",startX + disX);
			});
			
			wrap.addEventListener("touchend",function(ev){
				var touch =ev.changedTouches[0];
				//标记当前哪一个li占据着我们的视口
				
				
				
				
				
				now = Math.round(-cssTransform(list,"translateX")/wrap.offsetWidth);
				
				//限制超出
				if(now < 0){
					now=0;
				}
				if(now>lis.length-1){
					now=lis.length-1
				}
				
				/*cssTransform(list,"translateX",-now*wrap.offsetWidth);
				list.style.transition="1s";
				for(var i=0;i<nav.length;i++){
					nav[i].className="";
				}
				nav[now%nav.length].className="active";*/
				autoMove();
				auto();
			});
			
			
			//自动轮播
			auto();
			function auto(){
				clearTime =setInterval(function(){
					if(now==lis.length-1){
						list.style.transition="none";
						now=nav.length-1
						cssTransform(list,"translateX",-now*wrap.offsetWidth);
					}
					
					setTimeout(function(){
						now++;
						autoMove();
					},20);
				},2000);
			}
			
			
			function autoMove(){
				list.style.transition="1s";
				cssTransform(list,"translateX",-now*wrap.offsetWidth);
				
				for(var i=0;i<nav.length;i++){
					nav[i].className="";
				}
				nav[now%nav.length].className="active";
			}
			
		}
		
		//可同步的选项卡
		tab();
		function tab(){
				var tabNav =document.querySelectorAll(".tabNav");
				var tabList =document.querySelectorAll(".tabList");
				var tabNext =document.querySelectorAll(".tabNext");
				
				var translateX = tabNav[0].offsetWidth;
				for(var i=0;i<tabNav.length;i++){
					swipe(tabList[i],tabNav[i]);
				}
				
				function swipe(list,nav){
					var tabNavA =nav.getElementsByTagName("a");
					var tabNavSpan = nav.getElementsByTagName("span")[0];
					
					//开启3d硬件加速
					cssTransform(list,"translateZ",0.00001);
					cssTransform(list,"translateX",-translateX);
					
					var startpoint =0;
					var startX=0;
					var isX =true;
					var isFirst =true;
					var isLoading = true;
					var now=0;
					
					list.addEventListener("touchstart",function(ev){
						if(!isLoading){
							return;
						}
						list.style.transition="none";
						var touch ={clientX:ev.changedTouches[0].clientX,clientY:ev.changedTouches[0].clientY};
						startpoint = touch;
						startX= cssTransform(list,"translateX");
						
						isX =true;
						isFirst = true;
					});
					
					list.addEventListener("touchmove",function(ev){
						if(!isLoading){
							return;
						}
						if(!isX){
							return;
						}
						
						var touch =ev.changedTouches[0];
						var nowpoint=touch;
						var disX =nowpoint.clientX -startpoint.clientX;
						var disY =nowpoint.clientY -startpoint.clientY;
						
						if(isFirst){
							isFirst = false;
							if(Math.abs(disY)>Math.abs(disX)){
								isX=false;
								return;
							}
						}
						
						cssTransform(list,"translateX",startX + disX);
						
						if(Math.abs(disX)>translateX/2){
							end(disX);
						}
					});
					
					function end(disX){
						isLoading=false;
						
						tabNavSpan.style.transition="1s";
						var flag = disX >0?-1:1;
						now +=flag ;
						if(now<0){
							now=tabNavA.length-1;
							tabNavSpan.style.transition="none";
						}
						if(now>tabNavA.length-1){
							now=0;
							tabNavSpan.style.transition="none";
						}
						console.log(now);
						
						var traget =disX>0?0:-2*translateX;
						list.style.transition="300ms ";
						cssTransform(list,"translateX",traget);
						list.addEventListener("transitionend",transitionEnd);
						list.addEventListener("webkitTransitionEnd",transitionEnd);
					}
					function transitionEnd(){
						var left = tabNavA[now].offsetLeft;
						cssTransform(tabNavSpan,"translateX",left);
						
						list.removeEventListener("transitionend",transitionEnd);
						list.removeEventListener("webkitTransitionEnd",transitionEnd);
						for(var i=0;i<tabNext.length;i++){
							tabNext[i].style.opacity=1;
						}
						//发一个ajax请求
						setTimeout(function(){
							list.style.transition="none";
							cssTransform(list,"translateX",-translateX);
							isLoading=true;
							
							for(var i=0;i<tabNext.length;i++){
								tabNext[i].style.opacity=0;
							}
						},1000);
					}
					
					
					
					list.addEventListener("touchend",function(ev){
						if(!isLoading){
							return;
						}
						var touch =ev.changedTouches[0];
						var nowpoint=touch;
						var disX =nowpoint.clientX -startpoint.clientX;
						if(Math.abs(disX)<translateX/2){
							list.style.transition="300ms ";
							cssTransform(list,"translateX",-translateX);
						}
						
					});
					
					
				}
			}
</script>
</html>		